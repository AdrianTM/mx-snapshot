#!/bin/bash

# Root level functions requiring password for mx-snapshot

cleanup() {
    pkill mksquashfs
}

cleanup_overlay() {
    local app_name overlay_base lower_dir
    app_name=$1
    [[ -z "$app_name" ]] && exit 2
    [[ "$app_name" =~ ^[A-Za-z0-9._-]+$ ]] || exit 2
    overlay_base="/run/${app_name}/bind-root-overlay"
    lower_dir="${overlay_base}/lower"
    local overlay_root="${overlay_base}/root"

    mountpoint -q "$overlay_root" && umount --recursive "$overlay_root"
    mountpoint -q "$lower_dir" && umount --recursive "$lower_dir"
    [[ -L "$overlay_base" ]] && exit 3
    [[ -d "$overlay_base" && "$overlay_base" == /run/*/bind-root-overlay ]] && rm -rf "$overlay_base"
}

copy_log() {
    for app in iso-snapshot-cli mx-snapshot; do
        if [[ -f /tmp/${app}.log ]]; then
            [[ -f /var/log/${app}.log ]] && mv /var/log/${app}.log /var/log/${app}.log.old
            cp /tmp/${app}.log /var/log
            break
        fi
    done
}

datetime_log() {
    date +"%Y%m%d_%H%M" > /etc/snapshot_created
}

kill_mksquashfs() {
    pkill mksquashfs
}

drop_caches() {
    echo 1 > /proc/sys/vm/drop_caches
}

chown_conf() {
    for app in iso-snapshot-cli mx-snapshot; do
        FILE_NAME="/home/$(logname)/.config/MX-Linux/${app}.conf"
        [[ -f "$FILE_NAME" ]] && chown $(logname): "$FILE_NAME"
    done
}

main() {
case "$1" in
    chown_conf)
        chown_conf;;
    cleanup)
        cleanup;;
    cleanup_overlay)
        cleanup_overlay "$2";;
    copy_log)
        copy_log;;
    datetime_log)
        datetime_log;;
    kill_mksquashfs)
        kill_mksquashfs;;
    drop_caches)
        drop_caches;;
esac
}

main "$@"
